name: Daily NSE Option Analysis

on:
  schedule:
    - cron: '30 8 * * 1-5'  # Runs at 2:00 PM IST (8:30 UTC) on weekdays
  workflow_dispatch:         # Manual trigger

jobs:
  run-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests yfinance datetime python-dotenv
    
    - name: Create directories
      run: |
        mkdir -p data/raw
        mkdir -p data/processed
        mkdir -p data/comparison
        mkdir -p outputs/signals
        mkdir -p outputs/reports
        mkdir -p logs
        echo "‚úÖ Directories created successfully"
    
    - name: Download historical data (from previous run)
      uses: dawidd6/action-download-artifact@v6
      continue-on-error: true
      with:
        workflow: daily_option_analysis.yml
        name: nse-historical-data
        path: data/processed/
    
    - name: Check existing historical data
      run: |
        echo "=== Checking Historical Data ==="
        echo ""
        echo "üìä Historical files found:"
        if [ -d "data/processed" ]; then
          count=$(find data/processed -name "*.csv" -type f | wc -l)
          if [ $count -gt 0 ]; then
            echo "‚úÖ Found $count historical CSV files"
            echo ""
            echo "üìÅ Files:"
            ls -la data/processed/*.csv 2>/dev/null || echo "No CSV files"
            echo ""
            echo "üìÖ Latest file dates:"
            for file in data/processed/*.csv; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "- $filename: $(stat -c %y "$file" 2>/dev/null | cut -d' ' -f1)"
              fi
            done
          else
            echo "‚ö†Ô∏è No historical CSV files found (first run?)"
          fi
        else
          echo "‚ùå data/processed directory not found"
        fi
    
    - name: Run main analysis script
      run: python run.py
      continue-on-error: false
    
    - name: Upload historical data artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: nse-historical-data
        path: data/processed/
        retention-days: 90
        if-no-files-found: error
    
    - name: Upload reports artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: nse-analysis-reports
        path: outputs/
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload comparison results
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: nse-comparison-results
        path: data/comparison/
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Summary and logs
      run: |
        echo "=== ANALYSIS COMPLETE ==="
        echo ""
        echo "üìä Artifacts Generated:"
        echo "1. nse-historical-data - Historical CSV files"
        echo "2. nse-analysis-reports - Analysis reports"
        echo "3. nse-comparison-results - Day-over-day comparison"
        echo ""
        echo "üìÅ Files Created:"
        find outputs/ -type f | sort || echo "No output files"
        echo ""
        echo "üìÖ Data Files:"
        find data/processed -name "*.csv" -type f | sort || echo "No data files"
        echo ""
        echo "‚è∞ Next Run: Tomorrow at 2:00 PM IST"
        echo ""
        echo "‚úÖ Workflow completed successfully"
    
    - name: Commit and push results
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are any changes
        if git diff --quiet -- outputs/; then
          echo "‚úÖ No changes in outputs to commit"
        else
          echo "üìù Committing changes..."
          git add outputs/
          git commit -m "Update NSE analysis reports and signals $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          
          # Push changes
          echo "üöÄ Pushing changes..."
          git push || echo "Push failed or no changes"
        fi
